# NixOS Configuration Quick Reference

Quick reference for common operations in this NixOS configuration repository.

## Quick Commands

```bash
# Using the deploy.sh helper script
./deploy.sh switch lenovo-t14s-x1e    # Switch to configuration
./deploy.sh iso lenovo-t14s-x1e       # Build installer ISO
./deploy.sh check                      # Run all checks
./deploy.sh update                     # Update dependencies
./deploy.sh fmt                        # Format code

# Direct nix commands
nix fmt                                # Format all nix files
nix flake check                        # Run all checks
nix build .#packages.aarch64-linux.lenovo-t14s-x1e-iso  # Build ISO
sudo nixos-rebuild switch --flake .#lenovo-t14s-x1e     # Apply config
```

## File Structure

```
nixos/
├── flake.nix                  # Main flake - start here
├── modules/
│   ├── common.nix            # Shared config (GC, locale, packages)
│   ├── iso.nix               # ISO installer config
│   ├── users.nix             # Declarative user management
│   └── hardware-configuration-template.nix
├── hosts/
│   └── <hostname>/
│       ├── configuration.nix  # Host-specific config
│       └── hardware-configuration.nix
└── deploy.sh                  # Deployment helper
```

## Common Patterns

### Adding a New Host

```nix
# In flake.nix nixosConfigurations:
my-host = mkSystem {
  system = "x86_64-linux";
  hostname = "my-host";
  modules = [
    ./modules/common.nix
    ./hosts/my-host/configuration.nix
  ];
};

my-host-iso = mkISO {
  system = "x86_64-linux";
  hostname = "my-host";
  modules = [ /* hardware modules */ ];
};

# In packages:
my-host-iso = self.nixosConfigurations.my-host-iso.config.system.build.isoImage;
```

### Using Declarative Users

```nix
# In host configuration.nix:
imports = [ ../modules/users.nix ];

myUsers = {
  enable = true;
  users.alice = {
    isAdmin = true;
    description = "Alice Administrator";
    shell = pkgs.fish;
    sshKeys = [ "ssh-ed25519 AAAA..." ];
  };
};
```

### Overriding Common Settings

```nix
# Use lib.mkForce for must-override
security.sudo.wheelNeedsPassword = lib.mkForce false;

# Use lib.mkDefault for soft defaults (already used in common.nix)
time.timeZone = "America/New_York";  # Overrides UTC default
```

## Configuration Hierarchy

1. **common.nix** - Base configuration (all hosts)
   - System state version
   - Nix settings (flakes, GC, optimization)
   - Security defaults
   - Network defaults
   - Common packages

2. **Host configuration.nix** - Host-specific settings
   - Boot loader
   - Filesystems
   - Users
   - Host-specific packages
   - Service overrides

3. **Hardware configuration** - Generated by nixos-generate-config
   - Boot modules
   - Filesystem UUIDs
   - CPU/hardware specifics

## Troubleshooting

### Build Fails

```bash
# Check syntax
nix flake check

# Build without switching
nixos-rebuild build --flake .#hostname

# See what would change
nixos-rebuild dry-activate --flake .#hostname
```

### System Won't Boot

```bash
# Boot into previous generation from GRUB/systemd-boot
# Then check logs
journalctl -xb

# Rollback
sudo nixos-rebuild switch --rollback
```

### Flake Lock Issues

```bash
# Update all inputs
nix flake update

# Update specific input
nix flake lock --update-input nixpkgs
```

## Development Workflow

```bash
# Enter dev shell with tools
nix develop

# Make changes to configuration files
vim hosts/my-host/configuration.nix

# Format code
nix fmt

# Check evaluation
nix flake check

# Test build
nixos-rebuild build --flake .#my-host

# Apply if looks good
sudo nixos-rebuild switch --flake .#my-host
```

## Useful Queries

```bash
# Show all flake outputs
nix flake show

# List available hosts
nix eval .#nixosConfigurations --apply builtins.attrNames

# Check package in system
nix eval .#nixosConfigurations.my-host.config.environment.systemPackages

# Show current generation
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system
```

## Key Concepts

- **mkDefault**: Soft default, can be overridden normally
- **mkForce**: Hard override, takes precedence
- **mkOverride**: Custom priority (0-1000, lower = higher priority)
- **lib.mkIf**: Conditional configuration
- **lib.mkMerge**: Merge multiple configs

## Resources

- [NixOS Manual](https://nixos.org/manual/nixos/stable/)
- [NixOS Options Search](https://search.nixos.org/options)
- [Nix Pills](https://nixos.org/guides/nix-pills/)
- [This repo's CONTRIBUTING.md](CONTRIBUTING.md)

## Tips

- Always test in VM first: `nixos-rebuild build-vm --flake .#hostname`
- Use `nix-tree` to explore dependencies
- Keep configuration.nix focused on what differs from common.nix
- Use modules for reusable configuration patterns
- Version control flake.lock for reproducibility
- Document non-obvious configuration choices
